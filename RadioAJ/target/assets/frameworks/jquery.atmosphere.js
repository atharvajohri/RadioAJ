jQuery.atmosphere=function(){jQuery(window).bind("unload.atmosphere",function(){jQuery.atmosphere.unsubscribe()}),jQuery(window).keypress(function(e){27==e.keyCode&&e.preventDefault()});var parseHeaders=function(headerString){for(var match,rheaders=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,headers={};match=rheaders.exec(headerString);)headers[match[1]]=match[2];return headers};return{version:"1.1.0.beta2",requests:[],callbacks:[],onError:function(){},onClose:function(){},onOpen:function(){},onMessage:function(){},onReconnect:function(){},onMessagePublished:function(){},onTransportFailure:function(){},onLocalMessage:function(){},AtmosphereRequest:function(options){function _init(){_subscribed=!0,_abordingConnection=!1,_requestCount=0,_websocket=null,_sse=null,_activeRequest=null,_ieStream=null}function _reinit(){_clearState(),_init()}function _subscribe(options){_reinit(),_request=jQuery.extend(_request,options)}function _supportWebsocket(){return null!=_request.webSocketImpl||window.WebSocket||window.MozWebSocket}function _supportSSE(){return window.EventSource}function _execute(){if(_request.shared){if(_localStorageService=_local(_request),null!=_localStorageService&&("debug"==_request.logLevel&&jQuery.atmosphere.debug("Storage service available. All communication will be local"),_localStorageService.open(_request)))return;"debug"==_request.logLevel&&jQuery.atmosphere.debug("No Storage service available."),_localStorageService=null}"websocket"!=_request.transport&&"sse"!=_request.transport?(_open("opening",_request.transport,_request),_executeRequest()):"websocket"==_request.transport?_supportWebsocket()?_executeWebSocket(!1):_reconnectWithFallbackTransport("Websocket is not supported, using request.fallbackTransport ("+_request.fallbackTransport+")"):"sse"==_request.transport&&(_supportSSE()?_executeSSE(!1):_reconnectWithFallbackTransport("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+_request.fallbackTransport+")"))}function _local(request){function listener(string){var command=jQuery.parseJSON(string),data=command.data;if("c"===command.target)switch(command.type){case"open":_open("opening","local",_request);break;case"close":orphan||(orphan=!0,"aborted"===data.reason?_close():data.heir===guid?_execute():setTimeout(function(){_execute()},100));break;case"message":_prepareCallback(data,"messageReceived",200,request.transport);break;case"localMessage":_localMessage(data)}}function findTrace(){var matcher=new RegExp("(?:^|; )("+encodeURIComponent(name)+")=([^;]*)").exec(document.cookie);return matcher?jQuery.parseJSON(decodeURIComponent(matcher[2])):void 0}var trace,connector,orphan,name="atmosphere-"+request.url,connectors={storage:function(){if(jQuery.atmosphere.supportStorage()){var storage=window.localStorage,get=function(key){return jQuery.parseJSON(storage.getItem(name+"-"+key))},set=function(key,value){storage.setItem(name+"-"+key,jQuery.stringifyJSON(value))};return{init:function(){return set("children",get("children").concat([guid])),jQuery(window).on("storage.socket",function(event){event=event.originalEvent,event.key===name&&event.newValue&&listener(event.newValue)}),get("opened")},signal:function(type,data){storage.setItem(name,jQuery.stringifyJSON({target:"p",type:type,data:data}))},close:function(){var index,children=get("children");jQuery(window).off("storage.socket"),children&&(index=jQuery.inArray(request.id,children),index>-1&&(children.splice(index,1),set("children",children)))}}}},windowref:function(){var win=window.open("",name.replace(/\W/g,""));if(win&&!win.closed&&win.callbacks)return{init:function(){return win.callbacks.push(listener),win.children.push(guid),win.opened},signal:function(type,data){!win.closed&&win.fire&&win.fire(jQuery.stringifyJSON({target:"p",type:type,data:data}))},close:function(){function remove(array,e){var index=jQuery.inArray(e,array);index>-1&&array.splice(index,1)}orphan||(remove(win.callbacks,listener),remove(win.children,guid))}}}};return trace=findTrace(),!trace||jQuery.now()-trace.ts>1e3||!(connector=connectors.storage()||connectors.windowref())?void 0:{open:function(){var parentOpened;return _traceTimer=setInterval(function(){var oldTrace=trace;trace=findTrace(),trace&&oldTrace.ts!==trace.ts||listener(jQuery.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:oldTrace.heir}}))},1e3),parentOpened=connector.init(),parentOpened&&setTimeout(function(){_open("opening","local",request)},50),parentOpened},send:function(event){connector.signal("send",event)},localSend:function(event){connector.signal("localSend",jQuery.stringifyJSON({id:guid,event:event}))},close:function(){_abordingConnection||(clearInterval(_traceTimer),connector.signal("close"),connector.close())}}}function share(){function listener(string){var command=jQuery.parseJSON(string),data=command.data;if("p"===command.target)switch(command.type){case"send":_push(data);break;case"localSend":_localMessage(data);break;case"close":_close()}}function leaveTrace(){document.cookie=encodeURIComponent(name)+"="+encodeURIComponent(jQuery.stringifyJSON({ts:jQuery.now()+1,heir:(storageService.get("children")||[])[0]}))}var storageService,name="atmosphere-"+_request.url,servers={storage:function(){if(jQuery.atmosphere.supportStorage()){var storage=window.localStorage;return{init:function(){jQuery(window).on("storage.socket",function(event){event=event.originalEvent,event.key===name&&event.newValue&&listener(event.newValue)})},signal:function(type,data){storage.setItem(name,jQuery.stringifyJSON({target:"c",type:type,data:data}))},get:function(key){return jQuery.parseJSON(storage.getItem(name+"-"+key))},set:function(key,value){storage.setItem(name+"-"+key,jQuery.stringifyJSON(value))},close:function(){jQuery(window).off("storage.socket"),storage.removeItem(name),storage.removeItem(name+"-opened"),storage.removeItem(name+"-children")}}}},windowref:function(){var neim=name.replace(/\W/g,""),win=(jQuery('iframe[name="'+neim+'"]')[0]||jQuery('<iframe name="'+neim+'" />').hide().appendTo("body")[0]).contentWindow;return{init:function(){win.callbacks=[listener],win.fire=function(string){var i;for(i=0;i<win.callbacks.length;i++)win.callbacks[i](string)}},signal:function(type,data){!win.closed&&win.fire&&win.fire(jQuery.stringifyJSON({target:"c",type:type,data:data}))},get:function(key){return win.closed?null:win[key]},set:function(key,value){win.closed||(win[key]=value)},close:function(){}}}};_localSocketF=function(context){storageService.signal("message",context)},storageService=servers.storage()||servers.windowref(),storageService.init(),"debug"==_request.logLevel&&jQuery.atmosphere.debug("Installed StorageService "+storageService),storageService.set("children",[]),null==storageService.get("opened")||storageService.get("opened")||storageService.set("opened",!1),leaveTrace(),_traceTimer=setInterval(leaveTrace,1e3),_storageService=storageService}function _open(state,transport,request){_request.shared&&"local"!=transport&&share(),null!=_storageService&&_storageService.set("opened",!0),request.close=function(){_close(),request.reconnect=!1},_response.request=request;var prevState=_response.state;_response.state=state,_response.status=200;var prevTransport=_response.transport;_response.transport=transport;var _body=_response.responseBody;_invokeCallback(),_response.responseBody=_body,_response.state=prevState,_response.transport=prevTransport}function _jsonp(request){request.transport="jsonp";var rq=_request;null!=request&&"undefined"!=typeof request&&(rq=request);var url=rq.url;null!=rq.dispatchUrl&&(url+=rq.dispatchUrl);var data=rq.data;rq.attachHeadersAsQueryString&&(url=_attachHeaders(rq),""!=data&&(url+="&X-Atmosphere-Post-Body="+encodeURIComponent(data)),data=""),_jqxhr=jQuery.ajax({url:url,type:rq.method,dataType:"jsonp",error:function(jqXHR,textStatus){jqXHR.status<300?_reconnect(_jqxhr,rq):_prepareCallback(textStatus,"error",jqXHR.status,rq.transport)},jsonp:"jsonpTransport",success:function(json){if(rq.reconnect&&(-1==rq.maxRequest||rq.requestCount++<rq.maxRequest)){rq.executeCallbackBeforeReconnect||_reconnect(_jqxhr,rq);var msg=json.message;if(null!=msg&&"string"!=typeof msg)try{msg=jQuery.stringifyJSON(msg)}catch(err){}_prepareCallback(msg,"messageReceived",200,rq.transport),rq.executeCallbackBeforeReconnect&&_reconnect(_jqxhr,rq)}else jQuery.atmosphere.log(_request.logLevel,["JSONP reconnect maximum try reached "+_request.requestCount]),_onError()},data:rq.data,beforeSend:function(jqXHR){_doRequest(jqXHR,rq,!1)}})}function _ajax(request){var rq=_request;null!=request&&"undefined"!=typeof request&&(rq=request);var url=rq.url;null!=rq.dispatchUrl&&(url+=rq.dispatchUrl);var data=rq.data;rq.attachHeadersAsQueryString&&(url=_attachHeaders(rq),""!=data&&(url+="&X-Atmosphere-Post-Body="+encodeURIComponent(data)),data=""),_jqxhr=jQuery.ajax({url:url,type:rq.method,error:function(jqXHR,textStatus){jqXHR.status<300?_reconnect(_jqxhr,rq):_prepareCallback(textStatus,"error",jqXHR.status,rq.transport)},success:function(data){rq.reconnect&&(-1==rq.maxRequest||rq.requestCount++<rq.maxRequest)?(rq.executeCallbackBeforeReconnect||_reconnect(_jqxhr,rq),_prepareCallback(data,"messageReceived",200,rq.transport),rq.executeCallbackBeforeReconnect&&_reconnect(_jqxhr,rq)):(jQuery.atmosphere.log(_request.logLevel,["AJAX reconnect maximum try reached "+_request.requestCount]),_onError())},data:rq.data,beforeSend:function(jqXHR){_doRequest(jqXHR,rq,!1)}})}function _getWebSocket(location){return null!=_request.webSocketImpl?_request.webSocketImpl:window.WebSocket?new WebSocket(location):new MozWebSocket(location)}function _buildWebSocketUrl(){var url=_attachHeaders(_request);return decodeURI(jQuery('<a href="'+url+'"/>')[0].href.replace(/^http/,"ws"))}function _buildSSEUrl(){var url=_attachHeaders(_request);return url}function _executeSSE(sseOpened){_response.transport="sse";var location=_buildSSEUrl(_request.url);return"debug"==_request.logLevel&&(jQuery.atmosphere.debug("Invoking executeSSE"),jQuery.atmosphere.debug("Using URL: "+location)),sseOpened&&_open("re-opening","sse",_request),_request.reconnect?(_sse=new EventSource(location,{withCredentials:_request.withCredentials}),_request.connectTimeout>0&&(_request.id=setTimeout(function(){sseOpened||_sse.close()},_request.connectTimeout)),_sse.onopen=function(){"debug"==_request.logLevel&&jQuery.atmosphere.debug("SSE successfully opened"),sseOpened||_open("opening","sse",_request),sseOpened=!0,"POST"==_request.method&&(_response.state="messageReceived",_sse.send(_request.data))},_sse.onmessage=function(message){if(message.origin!="http://"+window.location.host)return void jQuery.atmosphere.log(_request.logLevel,["Origin was not http://"+window.location.host]);_response.state="messageReceived",_response.status=200;var message=message.data,skipCallbackInvocation=_trackMessageSize(message,_request,_response);0==jQuery.trim(message).length&&(skipCallbackInvocation=!0),skipCallbackInvocation||(_invokeCallback(),_response.responseBody="")},void(_sse.onerror=function(){clearTimeout(_request.id),_response.state="closed",_response.responseBody="",_response.status=sseOpened?200:501,_invokeCallback(),_sse.close(),_abordingConnection?jQuery.atmosphere.log(_request.logLevel,["SSE closed normally"]):sseOpened?_request.reconnect&&"sse"==_response.transport&&(_requestCount++<_request.maxReconnectOnClose?(_request.id=setTimeout(function(){_executeSSE(!0)},_request.reconnectInterval),_response.responseBody=""):(jQuery.atmosphere.log(_request.logLevel,["SSE reconnect maximum try reached "+_request.requestCount]),_onError())):_reconnectWithFallbackTransport("SSE failed. Downgrading to fallback transport and resending")})):void(null!=_sse&&_sse.close())}function _executeWebSocket(webSocketOpened){_response.transport="websocket";var location=_buildWebSocketUrl(_request.url),closed=!1;return"debug"==_request.logLevel&&(jQuery.atmosphere.debug("Invoking executeWebSocket"),jQuery.atmosphere.debug("Using URL: "+location)),webSocketOpened&&_open("re-opening","websocket",_request),_request.reconnect?(_websocket=_getWebSocket(location),_request.connectTimeout>0&&(_request.id=setTimeout(function(){if(!webSocketOpened){var _message={code:1002,reason:"",wasClean:!1};_websocket.onclose(_message);try{_websocket.close()}catch(e){}}},_request.connectTimeout)),_websocket.onopen=function(){"debug"==_request.logLevel&&jQuery.atmosphere.debug("Websocket successfully opened"),webSocketOpened||_open("opening","websocket",_request),webSocketOpened=!0,"POST"==_request.method&&(_response.state="messageReceived",_websocket.send(_request.data))},_websocket.onmessage=function(message){-1!=message.data.indexOf("parent.callback")&&jQuery.atmosphere.log(_request.logLevel,["parent.callback no longer supported with 0.8 version and up. Please upgrade"]),_response.state="messageReceived",_response.status=200;var message=message.data,skipCallbackInvocation=_trackMessageSize(message,_request,_response);skipCallbackInvocation||(_invokeCallback(),_response.responseBody="")},_websocket.onerror=function(){clearTimeout(_request.id)},void(_websocket.onclose=function(message){if(!closed){var reason=message.reason;if(""===reason)switch(message.code){case 1e3:reason="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:reason="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:reason="The endpoint is terminating the connection due to a protocol error.";break;case 1003:reason="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:reason="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:reason="Unknown: no status code was provided even though one was expected.";break;case 1006:reason="Connection was closed abnormally (that is, with no close frame being sent)."}jQuery.atmosphere.warn("Websocket closed, reason: "+reason),jQuery.atmosphere.warn("Websocket closed, wasClean: "+message.wasClean),_response.state="closed",_response.responseBody="",_response.status=webSocketOpened?200:501,_invokeCallback(),clearTimeout(_request.id),closed=!0,_abordingConnection?jQuery.atmosphere.log(_request.logLevel,["Websocket closed normally"]):webSocketOpened?_request.reconnect&&"websocket"==_response.transport&&(_requestCount++<_request.maxReconnectOnClose?(_request.requestCount=_requestCount,_response.responseBody="",_executeWebSocket(!0)):(jQuery.atmosphere.log(_request.logLevel,["Websocket reconnect maximum try reached "+_request.requestCount]),jQuery.atmosphere.warn("Websocket error, reason: "+message.reason),_onError())):_reconnectWithFallbackTransport("Websocket failed. Downgrading to Comet and resending")}})):void(null!=_websocket&&_websocket.close())}function _onError(){_response.state="error",_response.responseBody="",_response.status=500,_invokeCallback()}function _trackMessageSize(message,request,response){if(request.trackMessageLength){0!=response.partialMessage.length&&(message=response.partialMessage+message);for(var messages=[],messageLength=0,messageStart=message.indexOf(request.messageDelimiter);-1!=messageStart&&(messageLength=message.substring(messageLength,messageStart),message=message.substring(messageStart+request.messageDelimiter.length,message.length),!(0==message.length||message.length<messageLength));)messageStart=message.indexOf(request.messageDelimiter),messages.push(message.substring(0,messageLength));return response.partialMessage=0==messages.length||-1!=messageStart&&0!=message.length&&messageLength!=message.length?messageLength+request.messageDelimiter+message:"",0!=messages.length?(response.responseBody=messages.join(request.messageDelimiter),!1):!0}return response.responseBody=message,!1}function _reconnectWithFallbackTransport(errorMessage){jQuery.atmosphere.log(_request.logLevel,[errorMessage]),"undefined"!=typeof _request.onTransportFailure?_request.onTransportFailure(errorMessage,_request):"undefined"!=typeof jQuery.atmosphere.onTransportFailure&&jQuery.atmosphere.onTransportFailure(errorMessage,_request),_request.transport=_request.fallbackTransport;var reconnect=_request.reconnect&&_requestCount++<_request.maxReconnectOnClose;(reconnect&&"none"!=_request.transport||null==_request.transport)&&(_request.method=_request.fallbackMethod,_response.transport=_request.fallbackTransport,_request.id=setTimeout(function(){_execute()},_request.reconnectInterval))}function _attachHeaders(request,url){var rq=_request;return null!=request&&"undefined"!=typeof request&&(rq=request),null==url&&(url=rq.url),rq.attachHeadersAsQueryString?-1!=url.indexOf("X-Atmosphere-Framework")?url:(url+=-1!=url.indexOf("?")?"&":"?",url+="X-Atmosphere-tracking-id="+rq.uuid,url+="&X-Atmosphere-Framework="+jQuery.atmosphere.version,url+="&X-Atmosphere-Transport="+rq.transport,rq.trackMessageLength&&(url+="&X-Atmosphere-TrackMessageSize=true"),url+=void 0!=rq.lastTimestamp?"&X-Cache-Date="+rq.lastTimestamp:"&X-Cache-Date=0",""!=rq.contentType&&(url+="&Content-Type="+rq.contentType),jQuery.each(rq.headers,function(name,value){var h=jQuery.isFunction(value)?value.call(this,rq,request,_response):value;null!=h&&(url+="&"+encodeURIComponent(name)+"="+encodeURIComponent(h))}),url):url}function _buildAjaxRequest(){return jQuery.browser.msie&&"undefined"==typeof XMLHttpRequest&&(XMLHttpRequest=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(e){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}throw new Error("This browser does not support XMLHttpRequest.")}),new XMLHttpRequest}function _executeRequest(request){var rq=_request;if((null!=request||"undefined"!=typeof request)&&(rq=request),"jsonp"==rq.transport||rq.enableXDR&&jQuery.atmosphere.checkCORSSupport())return void _jsonp(rq);if("ajax"==rq.transport)return void _ajax(request);if("streaming"==rq.transport&&jQuery.browser.msie)return void(rq.enableXDR&&window.XDomainRequest?_ieXDR(rq):_ieStreaming(rq));if(rq.enableXDR&&window.XDomainRequest)return void _ieXDR(rq);if(rq.reconnect&&(-1==rq.maxRequest||rq.requestCount++<rq.maxRequest)){var ajaxRequest=_buildAjaxRequest();_doRequest(ajaxRequest,rq,!0),rq.suspend&&(_activeRequest=ajaxRequest),"polling"!=rq.transport&&(_response.transport=rq.transport),jQuery.browser.msie||(ajaxRequest.onerror=function(){try{_response.status=XMLHttpRequest.status}catch(e){_response.status=500}_response.status||(_response.status=500),_response.state="error",_invokeCallback(),_reconnect(ajaxRequest,rq,!0)}),ajaxRequest.onreadystatechange=function(){if(!_abordingConnection){var skipCallbackInvocation=!1,update=!1;if("streaming"==rq.transport&&rq.readyState>2&&4==ajaxRequest.readyState)return rq.readyState=0,rq.lastIndex=0,void _reconnect(ajaxRequest,rq,!0);if(rq.readyState=ajaxRequest.readyState,4==ajaxRequest.readyState?jQuery.browser.msie?update=!0:"streaming"==rq.transport?update=!0:"long-polling"==rq.transport&&(update=!0,clearTimeout(rq.id)):jQuery.browser.msie||3!=ajaxRequest.readyState||200!=ajaxRequest.status||"long-polling"==rq.transport?clearTimeout(rq.id):update=!0,update){var responseText=jQuery.trim(ajaxRequest.responseText);if(ajaxRequest.status>=500||0==ajaxRequest.status)return void _onError();if(_readHeaders(ajaxRequest,_request),"streaming"==rq.transport){var message=(responseText.substring(rq.lastIndex,responseText.length),responseText.substring(rq.lastIndex,responseText.length));if(skipCallbackInvocation=_trackMessageSize(message,rq,_response),rq.lastIndex=responseText.length,jQuery.browser.opera&&jQuery.atmosphere.iterate(function(){if(ajaxRequest.responseText.length>rq.lastIndex){try{_response.status=ajaxRequest.status,_response.headers=parseHeaders(ajaxRequest.getAllResponseHeaders()),_request.readResponsesHeaders&&_request.headers&&jQuery.each(_request.headers,function(name){var v=ajaxRequest.getResponseHeader(name);v&&(_response.headers[name]=v)})}catch(e){_response.status=404}rq.lastPingTime=(new Date).getTime(),_response.state="messageReceived",_response.responseBody=ajaxRequest.responseText.substring(rq.lastIndex),rq.lastIndex=ajaxRequest.responseText.length,_invokeCallback(),"streaming"==rq.transport&&ajaxRequest.responseText.length>rq.maxStreamingLength&&(ajaxRequest.abort(),_doRequest(ajaxRequest,rq,!0))}},0),skipCallbackInvocation)return}else skipCallbackInvocation=_trackMessageSize(responseText,rq,_response),rq.lastIndex=responseText.length;try{_response.status=ajaxRequest.status,_response.headers=parseHeaders(ajaxRequest.getAllResponseHeaders()),_readHeaders(ajaxRequest,rq)}catch(e){_response.status=404}_response.state=rq.suspend?0==_response.status?"closed":"messageReceived":"messagePublished",rq.executeCallbackBeforeReconnect||_reconnect(ajaxRequest,rq,!1),-1!=_response.responseBody.indexOf("parent.callback")&&jQuery.atmosphere.log(rq.logLevel,["parent.callback no longer supported with 0.8 version and up. Please upgrade"]),_invokeCallback(),rq.executeCallbackBeforeReconnect&&_reconnect(ajaxRequest,rq,!1),"streaming"==rq.transport&&responseText.length>rq.maxStreamingLength&&(ajaxRequest.abort(),_doRequest(ajaxRequest,rq,!0))}}},ajaxRequest.send(rq.data),rq.suspend&&(rq.id=setTimeout(function(){_subscribed&&(ajaxRequest.abort(),_subscribe(rq),_execute())},rq.timeout)),_subscribed=!0}else"debug"==rq.logLevel&&jQuery.atmosphere.log(rq.logLevel,["Max re-connection reached."]),_onError()}function _doRequest(ajaxRequest,request,create){var url=request.url;null!=request.dispatchUrl&&"POST"==request.method&&(url+=request.dispatchUrl),url=_attachHeaders(request,url),url=jQuery.atmosphere.prepareURL(url),create&&(ajaxRequest.open(request.method,url,!0),request.connectTimeout>-1&&(request.id=setTimeout(function(){0==request.requestCount&&(ajaxRequest.abort(),_prepareCallback("Connect timeout","closed",200,request.transport))},request.connectTimeout))),_request.withCredentials&&"withCredentials"in ajaxRequest&&(ajaxRequest.withCredentials=!0),_request.dropAtmosphereHeaders||(ajaxRequest.setRequestHeader("X-Atmosphere-Framework",jQuery.atmosphere.version),ajaxRequest.setRequestHeader("X-Atmosphere-Transport",request.transport),void 0!=request.lastTimestamp?ajaxRequest.setRequestHeader("X-Cache-Date",request.lastTimestamp):ajaxRequest.setRequestHeader("X-Cache-Date",0),request.trackMessageLength&&ajaxRequest.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),""!=request.contentType&&ajaxRequest.setRequestHeader("Content-Type",request.contentType),ajaxRequest.setRequestHeader("X-Atmosphere-tracking-id",request.uuid)),jQuery.each(request.headers,function(name,value){var h=jQuery.isFunction(value)?value.call(this,ajaxRequest,request,create,_response):value;null!=h&&ajaxRequest.setRequestHeader(name,h)})}function _reconnect(ajaxRequest,request,force){var reconnect=request.reconnect&&_requestCount++<request.maxReconnectOnClose;(reconnect&&force||request.suspend&&200==ajaxRequest.status&&"streaming"!=request.transport&&_subscribed)&&request.reconnect&&(_open("re-opening",request.transport,request),request.id=setTimeout(function(){_executeRequest()},request.reconnectInterval))}function _ieXDR(request){_ieStream=_configureXDR(request),_ieStream.open()}function _configureXDR(request){var rq=_request;null!=request&&"undefined"!=typeof request&&(rq=request);var transport=rq.transport,lastIndex=0,xdrCallback=function(xdr){var responseBody=xdr.responseText,isJunkEnded=!1;if(-1!=responseBody.indexOf("<!-- Welcome to the Atmosphere Framework.")&&(isJunkEnded=!0),isJunkEnded){var endOfJunk="<!-- EOD -->",endOfJunkLenght=endOfJunk.length,junkEnd=responseBody.indexOf(endOfJunk);-1!==junkEnd&&(responseBody=responseBody.substring(junkEnd+endOfJunkLenght+lastIndex),lastIndex+=responseBody.length)}_prepareCallback(responseBody,"messageReceived",200,transport)},xdr=new window.XDomainRequest,rewriteURL=rq.rewriteURL||function(url){var match=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(match&&match[1]){case"JSESSIONID":return url.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+match[2]+"$1");case"PHPSESSID":return url.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+match[2]+"&").replace(/&$/,"")}return url};xdr.onprogress=function(){handle(xdr)},xdr.onerror=function(){"polling"!=rq.transport&&_prepareCallback(xdr.responseText,"error",500,transport)},xdr.onload=function(){handle(xdr)};var handle=function(xdr){rq.lastMessage!=xdr.responseText&&(rq.lastMessage=xdr.responseText,rq.executeCallbackBeforeReconnect&&xdrCallback(xdr),"long-polling"==rq.transport&&rq.reconnect&&(-1==rq.maxRequest||rq.requestCount++<rq.maxRequest)&&(xdr.status=200,_reconnect(xdr,rq,!1)),rq.executeCallbackBeforeReconnect||xdrCallback(xdr))};return{open:function(){var url=rq.url;null!=rq.dispatchUrl&&(url+=rq.dispatchUrl),url=_attachHeaders(rq,url),xdr.open(rq.method,rewriteURL(url)),"GET"==rq.method?xdr.send():xdr.send(rq.data),rq.connectTimeout>-1&&(rq.id=setTimeout(function(){0==rq.requestCount&&(xdr.abort(),_prepareCallback("Connect timeout","closed",200,rq.transport))},rq.connectTimeout))},close:function(){xdr.abort(),_prepareCallback(xdr.responseText,"closed",200,transport)}}}function _ieStreaming(request){_ieStream=_configureIE(request),_ieStream.open()}function _configureIE(request){var rq=_request;null!=request&&"undefined"!=typeof request&&(rq=request);var stop,doc=new window.ActiveXObject("htmlfile");doc.open(),doc.close();var url=rq.url;return null!=rq.dispatchUrl&&(url+=rq.dispatchUrl),"polling"!=rq.transport&&(_response.transport=rq.transport),{open:function(){var iframe=doc.createElement("iframe");url=_attachHeaders(rq),""!=rq.data&&(url+="&X-Atmosphere-Post-Body="+encodeURIComponent(rq.data)),url=jQuery.atmosphere.prepareURL(url),iframe.src=url,doc.body.appendChild(iframe);var cdoc=iframe.contentDocument||iframe.contentWindow.document;stop=jQuery.atmosphere.iterate(function(){try{if(!cdoc.firstChild)return;if("complete"===cdoc.readyState)try{jQuery.noop(cdoc.fileSize)}catch(e){return _prepareCallback("Connection Failure","error",500,rq.transport),!1}var res=cdoc.body?cdoc.body.lastChild:cdoc,readResponse=function(){var clone=res.cloneNode(!0);clone.appendChild(cdoc.createTextNode("."));var text=clone.innerText,isJunkEnded=!0;if(-1==text.indexOf("<!-- Welcome to the Atmosphere Framework.")&&(isJunkEnded=!1),isJunkEnded){var endOfJunk="<!-- EOD -->",endOfJunkLength=endOfJunk.length,junkEnd=text.indexOf(endOfJunk)+endOfJunkLength;text=text.substring(junkEnd)}return text.substring(0,text.length-1)};if(!jQuery.nodeName(res,"pre")){var head=cdoc.head||cdoc.getElementsByTagName("head")[0]||cdoc.documentElement||cdoc,script=cdoc.createElement("script");script.text="document.write('<plaintext>')",head.insertBefore(script,head.firstChild),head.removeChild(script),res=cdoc.body.lastChild}return _prepareCallback(readResponse(),"opening",200,rq.transport),stop=jQuery.atmosphere.iterate(function(){var text=readResponse();return text.length>rq.lastIndex&&(_response.status=200,res.innerText="",_prepareCallback(text,"messageReceived",200,rq.transport),rq.lastIndex=0),"complete"===cdoc.readyState?(_prepareCallback("","closed",200,rq.transport),_prepareCallback("","re-opening",200,rq.transport),_ieStreaming(rq),!1):void 0},null),!1}catch(err){_onError(),jQuery.atmosphere.error(err)}})},close:function(){stop&&stop(),doc.execCommand("Stop"),_prepareCallback("","closed",200,rq.transport)}}}function _push(message){null!=_localStorageService?_pushLocal(message):null!=_activeRequest||null!=_sse?_pushAjaxMessage(message):null!=_ieStream?_pushIE(message):null!=_jqxhr?_pushJsonp(message):null!=_websocket&&_pushWebSocket(message)}function _pushLocal(message){_localStorageService.send(message)}function _intraPush(message){if(0!=message.length)try{_localStorageService?_localStorageService.localSend(message):_storageService.signal("localMessage",jQuery.stringifyJSON({id:guid,event:message}))}catch(err){jQuery.atmosphere.error(err)}}function _pushAjaxMessage(message){var rq=_getPushRequest(message);_executeRequest(rq)}function _pushIE(message){if(_request.enableXDR&&jQuery.atmosphere.checkCORSSupport()){var rq=_getPushRequest(message);rq.reconnect=!1,_jsonp(rq)}else _pushAjaxMessage(message)}function _pushJsonp(message){_pushAjaxMessage(message)}function _getStringMessage(message){var msg=message;return"object"==typeof msg&&(msg=message.data),msg}function _getPushRequest(message){var msg=_getStringMessage(message),rq={connected:!1,timeout:6e4,method:"POST",url:_request.url,contentType:_request.contentType,headers:_request.headers,reconnect:!0,callback:null,data:msg,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:_request.withCredentials,transport:"polling",attachHeadersAsQueryString:!0,enableXDR:_request.enableXDR,uuid:_request.uuid,dispatchUrl:_request.dispatchUrl};return"object"==typeof message&&(rq=jQuery.extend(rq,message)),rq}function _pushWebSocket(message){var data,msg=_getStringMessage(message);try{data=null!=_request.webSocketUrl?_request.webSocketPathDelimiter+_request.webSocketUrl+_request.webSocketPathDelimiter+msg:msg,_websocket.send(data)}catch(e){_websocket.onclose=function(){},_websocket.close(),_reconnectWithFallbackTransport("Websocket failed. Downgrading to Comet and resending "+data),_pushAjaxMessage(message)}}function _localMessage(message){var m=jQuery.parseJSON(message);m.id!=guid&&("undefined"!=typeof _request.onLocalMessage?_request.onLocalMessage(m.event):"undefined"!=typeof jQuery.atmosphere.onLocalMessage&&jQuery.atmosphere.onLocalMessage(m.event))}function _prepareCallback(messageBody,state,errorCode,transport){"messageReceived"==state&&_trackMessageSize(messageBody,_request,_response)||(_response.transport=transport,_response.status=errorCode,_response.state=state,_response.responseBody=messageBody,_invokeCallback())}function _readHeaders(xdr,request){if(!request.readResponsesHeaders)return request.lastTimestamp=jQuery.now(),void(request.uuid=jQuery.atmosphere.guid());try{var tempDate=xdr.getResponseHeader("X-Cache-Date");tempDate&&null!=tempDate&&tempDate.length>0&&(request.lastTimestamp=tempDate.split(" ").pop());var tempUUID=xdr.getResponseHeader("X-Atmosphere-tracking-id");tempUUID&&null!=tempUUID&&(request.uuid=tempUUID.split(" ").pop()),request.headers&&jQuery.each(_request.headers,function(name){var v=xdr.getResponseHeader(name);v&&(_response.headers[name]=v)})}catch(e){}}function _invokeFunction(response){_f(response,_request),_f(response,jQuery.atmosphere)}function _f(response,f){switch(response.state){case"messageReceived":"undefined"!=typeof f.onMessage&&f.onMessage(response);break;case"error":"undefined"!=typeof f.onError&&f.onError(response);break;case"opening":"undefined"!=typeof f.onOpen&&f.onOpen(response);break;case"messagePublished":"undefined"!=typeof f.onMessagePublished&&f.onMessagePublished(response);break;case"re-opening":"undefined"!=typeof f.onReconnect&&f.onReconnect(_request,response);break;case"unsubscribe":case"closed":"undefined"!=typeof f.onClose&&f.onClose(response)}}function _invokeCallback(){for(var call=function(index,func){func(_response)},messages="string"==typeof _response.responseBody?_response.responseBody.split(_request.messageDelimiter):new Array(_response.responseBody),i=0;i<messages.length;i++)if(!(messages.length>1&&0==messages[i].length)&&(_response.responseBody=jQuery.trim(messages[i]),null==_localStorageService&&null!=_localSocketF&&_localSocketF(_response.responseBody),0!=_response.responseBody.length||"streaming"!=_response.transport||"messageReceived"!=_response.state)){if(_invokeFunction(_response),jQuery.atmosphere.callbacks.length>0){"debug"==_request.logLevel&&jQuery.atmosphere.debug("Invoking "+jQuery.atmosphere.callbacks.length+" global callbacks: "+_response.state);try{jQuery.each(jQuery.atmosphere.callbacks,call)
}catch(e){jQuery.atmosphere.log(_request.logLevel,["Callback exception"+e])}}if("function"==typeof _request.callback){"debug"==_request.logLevel&&jQuery.atmosphere.debug("Invoking request callbacks");try{_request.callback(_response)}catch(e){jQuery.atmosphere.log(_request.logLevel,["Callback exception"+e])}}}}function _close(){_request.reconnect=!1,_response.request=_request,_subscribed=!1,_abordingConnection=!0,_response.state="unsubscribe",_response.responseBody="",_response.status=408,_invokeCallback(),_clearState(),null!=_storageService&&(clearInterval(_traceTimer),document.cookie=encodeURIComponent("atmosphere-"+_request.url)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT",_storageService.signal("close",{reason:"",heir:_abordingConnection?(_storageService.get("children")||[])[0]:guid}),_storageService.close()),null!=_localStorageService&&_localStorageService.close()}function _clearState(){null!=_ieStream&&(_ieStream.close(),_ieStream=null),null!=_jqxhr&&(_jqxhr.abort(),_jqxhr=null),null!=_activeRequest&&(_activeRequest.abort(),_activeRequest=null),null!=_websocket&&(_websocket.close(),_websocket=null),null!=_sse&&(_sse.close(),_sse=null)}var _storageService,_traceTimer,_request={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,lastTimestamp:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropAtmosphereHeaders:!0,uuid:0,shared:!1,readResponsesHeaders:!0,maxReconnectOnClose:5,onError:function(){},onClose:function(){},onOpen:function(){},onMessage:function(){},onReconnect:function(){},onMessagePublished:function(){},onTransportFailure:function(){},onLocalMessage:function(){}},_response={status:200,responseBody:"",headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",id:0},_websocket=null,_sse=null,_activeRequest=null,_ieStream=null,_jqxhr=null,_subscribed=!0,_requestCount=0,_abordingConnection=!1,_localSocketF=null,_localStorageService=null,guid=jQuery.now();_subscribe(options),this.subscribe=function(options){_subscribe(options),_execute()},this.execute=function(){_execute()},this.invokeCallback=function(){_invokeCallback()},this.close=function(){_close()},this.getUrl=function(){return _request.url},this.push=function(message,dispatchUrl){if(null!=dispatchUrl){var originalDispatchUrl=_request.dispatchUrl;_request.dispatchUrl=dispatchUrl,_push(message),_request.dispatchUrl=originalDispatchUrl}else _push(message)},this.pushLocal=function(message){_intraPush(message)},this.request=_request,this.response=_response},subscribe:function(url,callback,request){"function"==typeof callback&&jQuery.atmosphere.addCallback(callback),"string"!=typeof url?request=url:request.url=url;var rq=new jQuery.atmosphere.AtmosphereRequest(request);return rq.execute(),jQuery.atmosphere.requests[jQuery.atmosphere.requests.length]=rq,rq},addCallback:function(func){-1==jQuery.inArray(func,jQuery.atmosphere.callbacks)&&jQuery.atmosphere.callbacks.push(func)},removeCallback:function(func){var index=jQuery.inArray(func,jQuery.atmosphere.callbacks);-1!=index&&jQuery.atmosphere.callbacks.splice(index,1)},unsubscribe:function(){if(jQuery.atmosphere.requests.length>0)for(var requestsClone=[].concat(jQuery.atmosphere.requests),i=0;i<requestsClone.length;i++){var rq=requestsClone[i];rq.close(),clearTimeout(rq.id)}jQuery.atmosphere.requests=[],jQuery.atmosphere.callbacks=[]},unsubscribeUrl:function(url){var idx=-1;if(jQuery.atmosphere.requests.length>0)for(var i=0;i<jQuery.atmosphere.requests.length;i++){var rq=jQuery.atmosphere.requests[i];if(rq.getUrl()==url){rq.close(),clearTimeout(rq.id),idx=i;break}}idx>=0&&jQuery.atmosphere.requests.splice(idx,1)},publish:function(request){"function"==typeof request.callback&&jQuery.atmosphere.addCallback(callback),request.transport="polling";var rq=new jQuery.atmosphere.AtmosphereRequest(request);return jQuery.atmosphere.requests[jQuery.atmosphere.requests.length]=rq,rq},checkCORSSupport:function(){if(jQuery.browser.msie&&!window.XDomainRequest)return!0;if(jQuery.browser.opera)return!0;var ua=navigator.userAgent.toLowerCase(),isAndroid=ua.indexOf("android")>-1;return isAndroid?!0:!1},S4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid:function(){return jQuery.atmosphere.S4()+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+jQuery.atmosphere.S4()+jQuery.atmosphere.S4()},prepareURL:function(url){var ts=jQuery.now(),ret=url.replace(/([?&])_=[^&]*/,"$1_="+ts);return ret+(ret===url?(/\?/.test(url)?"&":"?")+"_="+ts:"")},param:function(data){return jQuery.param(data,jQuery.ajaxSettings.traditional)},supportStorage:function(){var storage=window.localStorage;if(storage)try{return storage.setItem("t","t"),storage.removeItem("t"),window.StorageEvent&&!jQuery.browser.msie&&!(jQuery.browser.mozilla&&"1"===jQuery.browser.version.split(".")[0])}catch(e){}return!1},iterate:function(fn,interval){var timeoutId;return interval=interval||0,function loop(){timeoutId=setTimeout(function(){fn()!==!1&&loop()},interval)}(),function(){clearTimeout(timeoutId)}},log:function(level,args){if(window.console){var logger=window.console[level];"function"==typeof logger&&logger.apply(window.console,args)}},warn:function(){jQuery.atmosphere.log("warn",arguments)},info:function(){jQuery.atmosphere.log("info",arguments)},debug:function(){jQuery.atmosphere.log("debug",arguments)},error:function(){jQuery.atmosphere.log("error",arguments)}}}(),function(jQuery){function quote(string){return'"'+string.replace(escapable,function(a){var c=meta[a];return"string"==typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function f(n){return 10>n?"0"+n:n}function str(key,holder){var i,v,len,partial,value=holder[key],type=typeof value;switch(value&&"object"==typeof value&&"function"==typeof value.toJSON&&(value=value.toJSON(key),type=typeof value),type){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":return String(value);case"object":if(!value)return"null";switch(Object.prototype.toString.call(value)){case"[object Date]":return isFinite(value.valueOf())?'"'+value.getUTCFullYear()+"-"+f(value.getUTCMonth()+1)+"-"+f(value.getUTCDate())+"T"+f(value.getUTCHours())+":"+f(value.getUTCMinutes())+":"+f(value.getUTCSeconds())+'Z"':"null";case"[object Array]":for(len=value.length,partial=[],i=0;len>i;i++)partial.push(str(i,value)||"null");return"["+partial.join(",")+"]";default:partial=[];for(i in value)Object.prototype.hasOwnProperty.call(value,i)&&(v=str(i,value),v&&partial.push(quote(i)+":"+v));return"{"+partial.join(",")+"}"}}}var escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};jQuery.stringifyJSON=function(value){return window.JSON&&window.JSON.stringify?window.JSON.stringify(value):str("",{"":value})}}(jQuery);