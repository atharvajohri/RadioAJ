(function(){var Byte,Client,Frame,Stomp,__hasProp={}.hasOwnProperty,__slice=[].slice;Byte={LF:"\n",NULL:"\x00"},Frame=function(){function Frame(command,headers,body){this.command=command,this.headers=null!=headers?headers:{},this.body=null!=body?body:""}var unmarshallSingle;return Frame.prototype.toString=function(){var lines,name,value,_ref;lines=[this.command],_ref=this.headers;for(name in _ref)__hasProp.call(_ref,name)&&(value=_ref[name],lines.push(""+name+":"+value));return this.body&&lines.push("content-length:"+Frame.sizeOfUTF8(this.body)),lines.push(Byte.LF+this.body),lines.join(Byte.LF)},Frame.sizeOfUTF8=function(s){return s?encodeURI(s).split(/%..|./).length-1:0},unmarshallSingle=function(data){var body,chr,command,divider,headerLines,headers,i,idx,len,line,start,trim,_i,_j,_len,_ref,_ref1;for(divider=data.search(RegExp(""+Byte.LF+Byte.LF)),headerLines=data.substring(0,divider).split(Byte.LF),command=headerLines.shift(),headers={},trim=function(str){return str.replace(/^\s+|\s+$/g,"")},_ref=headerLines.reverse(),_i=0,_len=_ref.length;_len>_i;_i++)line=_ref[_i],idx=line.indexOf(":"),headers[trim(line.substring(0,idx))]=trim(line.substring(idx+1));if(body="",start=divider+2,headers["content-length"])len=parseInt(headers["content-length"]),body=(""+data).substring(start,start+len);else for(chr=null,i=_j=start,_ref1=data.length;(_ref1>=start?_ref1>_j:_j>_ref1)&&(chr=data.charAt(i),chr!==Byte.NULL);i=_ref1>=start?++_j:--_j)body+=chr;return new Frame(command,headers,body)},Frame.unmarshall=function(datas){var data;return function(){var _i,_len,_ref,_results;for(_ref=datas.split(RegExp(""+Byte.NULL+Byte.LF+"*")),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)data=_ref[_i],(null!=data?data.length:void 0)>0&&_results.push(unmarshallSingle(data));return _results}()},Frame.marshall=function(command,headers,body){var frame;return frame=new Frame(command,headers,body),frame.toString()+Byte.NULL},Frame}(),Client=function(){function Client(ws){this.ws=ws,this.ws.binaryType="arraybuffer",this.counter=0,this.connected=!1,this.heartbeat={outgoing:1e4,incoming:1e4},this.maxWebSocketFrameSize=16384,this.subscriptions={}}var now;return Client.prototype.debug=function(message){var _ref;return"undefined"!=typeof window&&null!==window&&null!=(_ref=window.console)?_ref.log(message):void 0},now=function(){return Date.now||(new Date).valueOf},Client.prototype._transmit=function(command,headers,body){var out;for(out=Frame.marshall(command,headers,body),"function"==typeof this.debug&&this.debug(">>> "+out);;){if(!(out.length>this.maxWebSocketFrameSize))return this.ws.send(out);this.ws.send(out.substring(0,this.maxWebSocketFrameSize)),out=out.substring(this.maxWebSocketFrameSize),"function"==typeof this.debug&&this.debug("remaining = "+out.length)}},Client.prototype._setupHeartbeat=function(headers){var serverIncoming,serverOutgoing,ttl,v,_ref,_ref1,_this=this;if((_ref=headers.version)===Stomp.VERSIONS.V1_1||_ref===Stomp.VERSIONS.V1_2)return _ref1=function(){var _i,_len,_ref1,_results;for(_ref1=headers["heart-beat"].split(","),_results=[],_i=0,_len=_ref1.length;_len>_i;_i++)v=_ref1[_i],_results.push(parseInt(v));return _results}(),serverOutgoing=_ref1[0],serverIncoming=_ref1[1],0!==this.heartbeat.outgoing&&0!==serverIncoming&&(ttl=Math.max(this.heartbeat.outgoing,serverIncoming),"function"==typeof this.debug&&this.debug("send PING every "+ttl+"ms"),this.pinger=Stomp.setInterval(ttl,function(){return _this.ws.send(Byte.LF),"function"==typeof _this.debug?_this.debug(">>> PING"):void 0})),0!==this.heartbeat.incoming&&0!==serverOutgoing?(ttl=Math.max(this.heartbeat.incoming,serverOutgoing),"function"==typeof this.debug&&this.debug("check PONG every "+ttl+"ms"),this.ponger=Stomp.setInterval(ttl,function(){var delta;return delta=now()-_this.serverActivity,delta>2*ttl?("function"==typeof _this.debug&&_this.debug("did not receive server activity for the last "+delta+"ms"),_this.ws.close()):void 0})):void 0},Client.prototype._parseConnect=function(){var args,connectCallback,errorCallback,headers;switch(args=1<=arguments.length?__slice.call(arguments,0):[],headers={},args.length){case 2:headers=args[0],connectCallback=args[1];break;case 3:args[1]instanceof Function?(headers=args[0],connectCallback=args[1],errorCallback=args[2]):(headers.login=args[0],headers.passcode=args[1],connectCallback=args[2]);break;case 4:headers.login=args[0],headers.passcode=args[1],connectCallback=args[2],errorCallback=args[3];break;default:headers.login=args[0],headers.passcode=args[1],connectCallback=args[2],errorCallback=args[3],headers.host=args[4]}return[headers,connectCallback,errorCallback]},Client.prototype.connect=function(){var args,errorCallback,headers,out,_this=this;return args=1<=arguments.length?__slice.call(arguments,0):[],out=this._parseConnect.apply(this,args),headers=out[0],this.connectCallback=out[1],errorCallback=out[2],"function"==typeof this.debug&&this.debug("Opening Web Socket..."),this.ws.onmessage=function(evt){var arr,c,client,data,frame,messageID,onreceive,subscription,_i,_len,_ref,_results;if(data="undefined"!=typeof ArrayBuffer&&evt.data instanceof ArrayBuffer?(arr=new Uint8Array(evt.data),"function"==typeof _this.debug?_this.debug("--- got data length: "+arr.length):void 0,function(){var _i,_len,_results;for(_results=[],_i=0,_len=arr.length;_len>_i;_i++)c=arr[_i],_results.push(String.fromCharCode(c));return _results}().join("")):evt.data,_this.serverActivity=now(),data===Byte.LF)return void("function"==typeof _this.debug&&_this.debug("<<< PONG"));for("function"==typeof _this.debug&&_this.debug("<<< "+data),_ref=Frame.unmarshall(data),_results=[],_i=0,_len=_ref.length;_len>_i;_i++)switch(frame=_ref[_i],frame.command){case"CONNECTED":"function"==typeof _this.debug&&_this.debug("connected to server "+frame.headers.server),_this.connected=!0,_this._setupHeartbeat(frame.headers),_results.push("function"==typeof _this.connectCallback?_this.connectCallback(frame):void 0);break;case"MESSAGE":subscription=frame.headers.subscription,onreceive=_this.subscriptions[subscription]||_this.onreceive,onreceive?(client=_this,messageID=frame.headers["message-id"],frame.ack=function(headers){return null==headers&&(headers={}),client.ack(messageID,subscription,headers)},frame.nack=function(headers){return null==headers&&(headers={}),client.nack(messageID,subscription,headers)},_results.push(onreceive(frame))):_results.push("function"==typeof _this.debug?_this.debug("Unhandled received MESSAGE: "+frame):void 0);break;case"RECEIPT":_results.push("function"==typeof _this.onreceipt?_this.onreceipt(frame):void 0);break;case"ERROR":_results.push("function"==typeof errorCallback?errorCallback(frame):void 0);break;default:_results.push("function"==typeof _this.debug?_this.debug("Unhandled frame: "+frame):void 0)}return _results},this.ws.onclose=function(){var msg;return msg="Whoops! Lost connection to "+_this.ws.url,"function"==typeof _this.debug&&_this.debug(msg),_this._cleanUp(),"function"==typeof errorCallback?errorCallback(msg):void 0},this.ws.onopen=function(){return"function"==typeof _this.debug&&_this.debug("Web Socket Opened..."),headers["accept-version"]=Stomp.VERSIONS.supportedVersions(),headers["heart-beat"]=[_this.heartbeat.outgoing,_this.heartbeat.incoming].join(","),_this._transmit("CONNECT",headers)}},Client.prototype.disconnect=function(disconnectCallback){return this._transmit("DISCONNECT"),this.ws.onclose=null,this.ws.close(),this._cleanUp(),"function"==typeof disconnectCallback?disconnectCallback():void 0},Client.prototype._cleanUp=function(){return this.connected=!1,this.pinger&&Stomp.clearInterval(this.pinger),this.ponger?Stomp.clearInterval(this.ponger):void 0},Client.prototype.send=function(destination,headers,body){return null==headers&&(headers={}),null==body&&(body=""),headers.destination=destination,this._transmit("SEND",headers,body)},Client.prototype.subscribe=function(destination,callback,headers){var client;return null==headers&&(headers={}),headers.id||(headers.id="sub-"+this.counter++),headers.destination=destination,this.subscriptions[headers.id]=callback,this._transmit("SUBSCRIBE",headers),client=this,{id:headers.id,unsubscribe:function(){return client.unsubscribe(headers.id)}}},Client.prototype.unsubscribe=function(id){return delete this.subscriptions[id],this._transmit("UNSUBSCRIBE",{id:id})},Client.prototype.begin=function(transaction){var client,txid;return txid=transaction||"tx-"+this.counter++,this._transmit("BEGIN",{transaction:txid}),client=this,{id:txid,commit:function(){return client.commit(txid)},abort:function(){return client.abort(txid)}}},Client.prototype.commit=function(transaction){return this._transmit("COMMIT",{transaction:transaction})},Client.prototype.abort=function(transaction){return this._transmit("ABORT",{transaction:transaction})},Client.prototype.ack=function(messageID,subscription,headers){return null==headers&&(headers={}),headers["message-id"]=messageID,headers.subscription=subscription,this._transmit("ACK",headers)},Client.prototype.nack=function(messageID,subscription,headers){return null==headers&&(headers={}),headers["message-id"]=messageID,headers.subscription=subscription,this._transmit("NACK",headers)},Client}(),Stomp={VERSIONS:{V1_0:"1.0",V1_1:"1.1",V1_2:"1.2",supportedVersions:function(){return"1.1,1.0"}},client:function(url,protocols){var klass,ws;return null==protocols&&(protocols=["v10.stomp","v11.stomp"]),klass=Stomp.WebSocketClass||WebSocket,ws=new klass(url,protocols),new Client(ws)},over:function(ws){return new Client(ws)},Frame:Frame},"undefined"!=typeof window&&null!==window?(Stomp.setInterval=function(interval,f){return window.setInterval(f,interval)},Stomp.clearInterval=function(id){return window.clearInterval(id)},window.Stomp=Stomp):"undefined"!=typeof exports&&null!==exports?exports.Stomp=Stomp:self.Stomp=Stomp}).call(this);